#cloud-config
envar:
  - http_proxy : proxy.cse.cuhk.edu.hk:8000
  - https_proxy : proxy.cse.cuhk.edu.hk:8000
  - no_proxy : cse.cuhk.edu.hk,.cse.cuhk.edu.hk,localhost
ssh_authorized_keys:
  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIP8lyVDmMwXauShyBZXBH5gXY6FpG2+UsAuAkHko0ALq jlhu@cse.cuhk.edu.hk
users:
  - name: cloud
    passwd: $6$Oz3zW/5.6eBSs3FW$cejrseWHfTl6lfJeXT9JKO3Y9liNFiZ6I0cK3SURf3GUtT2CsB47V2lvsqqQ/T8bx5GQ3xJaYfWrU9u8/hJ9i0
    groups: wheel
    no-create-home: false
    sudo:
      - ALL=(ALL) NOPASSWD:ALL
    inactive: false
    system: true
write_files:
  -
    path: /etc/systemd/system/notify-booted.service
    permissions: 0644
    content: |
        [Unit]
        Description=Notify the tcp listener on the host that the guest is booted
        After=sshd.service

        [Service]
        Type=simple
        ExecStart=/usr/bin/cloud-hypervisor-notify-booted.sh
        Restart=on-failure
        RestartSec=2

        [Install]
        WantedBy=multi-user.target
  -
    path: /usr/bin/cloud-hypervisor-notify-booted.sh
    permissions: 0755
    content: |
        #!/bin/bash
        set -e
        echo -n "@DEFAULT_TCP_LISTENER_MESSAGE" > /dev/tcp/@HOST_IP/@TCP_LISTENER_PORT
  -
    path: /etc/systemd/network/11-id0.network
    permissions: 0644
    content: |
        [Match]
        MACAddress=12:34:56:78:90:ab

        [Network]
        Address=192.168.2.2/24
        Gateway=192.168.2.1
  -
    path: /etc/systemd/network/11-id1.network
    permissions: 0644
    content: |
        [Match]
        MACAddress=de:ad:be:ef:12:34

        [Network]
        Address=192.168.2.3/24
        Gateway=192.168.2.1
  -
    path: /etc/systemd/network/11-id2.network
    permissions: 0644
    content: |
        [Match]
        MACAddress=de:ad:be:ef:34:56

        [Network]
        Address=192.168.2.4/24
        Gateway=192.168.2.1
  -
    path: /etc/systemd/network/11-id3.network
    permissions: 0644
    content: |
        [Match]
        MACAddress=de:ad:be:ef:56:78

        [Network]
        Address=192.168.2.5/24
        Gateway=192.168.2.1
service:
  - reload
  - restart: systemd-networkd
  - enable: notify-booted.service
runcmd:
  - [ systemctl, start, --no-block, notify-booted.service ]
package_upgrade: true
packages:
  - curl
